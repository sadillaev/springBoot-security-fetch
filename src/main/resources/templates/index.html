<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>
<body>
<div class="container">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <ul class="nav navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-toggle="pill" href="#adminPage">Admin</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="pill" href="#adminUser">User</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="/login">logout</a></li>
            </ul>
        </div>
    </nav>

<div class="text-center">
    <h1>Users table</h1>
</div>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="adminPage">
            <div class="container">
                <li class="nav-item">
                    <button class="btn btn-outline-success" data-toggle="modal" data-target="#addUser">add new user</button>
                </li>
                <table id="users_table" class="table table-hover table-striped">

                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="adminUser">
            <div class="container">
                <table id="userAdmin" class="table table-hover table-striped"></table>
            </div>
        </div>
    </div>




</div>
<!--Modal-->
<div class="modal fade" id="addUser" tabindex="-1" aria-labelledby="#addUserLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserLabel">Form</h5>
                <button class="btn close" data-dismiss="modal" aria-label="close"></button>
            </div>
                <div class="modal-body">
                    <form id="add" method="post">
                        <div class="form-group" align="center">
                            <label for="name">Name</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="name" placeholder="Name">
                        </div>
                        <div class="form-group" align="center">
                            <label for="lastName">lastName</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="lastName" placeholder="lastName">
                        </div>
                        <div class="form-group" align="center">
                            <label for="email">email</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="email" placeholder="email">
                        </div>
                        <div class="form-group" align="center">
                            <label for="password">Password</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="password" placeholder="Password">
                        </div>
                        <div class="form-group" align="center">
                            <label for="address">address</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="address" placeholder="address">
                        </div>
                        <div class="form-group" align="center">
                            <label for="age">Age</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="age" placeholder="age">
                        </div>
                        <div class="form-group" align="center">
                            <input type="submit" value="addUser">
                </div>
                    </form>
        </div>
    </div>
</div>
</div>
<!--Modal-->

<!--    form for update user-->

    <!--Modal-->
    <div class="modal fade" id="updateUser" tabindex="-1" aria-labelledby="#updateUserLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateUserLabel">Form for editUser</h5>
                    <button class="btn close" data-dismiss="modal" aria-label="close"></button>
                </div>
                <div class="modal-body">
                    <form id="update">
                        <div class="form-group" align="center">
                            <label for="editId">id</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="editId" placeholder="name">
                        </div>
                        <div class="form-group" align="center">
                            <label for="name">Name</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="editName" placeholder="name">
                        </div>
                        <div class="form-group" align="center">
                            <label for="editLastName">lastName</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="editLastName" placeholder="lastName">
                        </div>
                        <div class="form-group" align="center">
                            <label for="email">email</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="editEmail" placeholder="email">
                        </div>
                        <div class="form-group" align="center">
                            <label for="password">Password</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="editPassword" placeholder="Password">
                        </div>
                        <div class="form-group" align="center">
                            <label for="editAddress">address</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="editAddress" placeholder="address">
                        </div>
                        <div class="form-group" align="center">
                            <label for="age">Age</label>
                            <br>
                            <input type="text" class="control-input col-sm-10" id="editAge" placeholder="age">
                        </div>
                        <div class="form-group" align="center">
                            <input type="submit" value="updateUser">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>




<!--<script src="./index.js"></script>-->
<script>            // получение всех пользоватедей

async function getAllUsers() {
    let response = await fetch('http://localhost:8080/api/users')
    let content = await response.json()
        .then(users => {
            let li = `
            <tr>
            <th scope="col">id</th>
            <th scope="col">name</th>
            <th scope="col">lastName</th>
            <th scope="col">email</th>
            <th scope="col">address</th>
            <th scope="col">age</th>
            <th scope="col">role</th>
            <th scope="col">update</th>
            <th scope="col">delete</th>
            </tr>`;
            users.forEach(u => {
                let userRole = '';
                for (let i = 0; i < u.roles.length; i++) {
                    userRole += `${u.roles[i].role}`
                }
                console.log(users)
                console.log(userRole)
                li += `
                <tr>
                <td>${u.id}</td>
                <td id="nameValue${u.id}">${u.name}</td>
                <td id="lastNameValue${u.id}">${u.lastName}</td>
                <td id="emailValue${u.id}">${u.email}</td>
                <td id="addressValue${u.id}">${u.address}</td>
                <td id="ageValue${u.id}">${u.age}</td>
                <td id="ageValue${u.id}">${userRole}</td>
                <td><button onclick="getUserdata(${u.id})" class="btn btn-outline-success" data-toggle="modal" data-target="#updateUser">edit</button>
</td>
                <td data-id="${u.id}"><a href="#" class="card-link" id="delete-user" >delete</a></td>

                </tr>`
            });
            document.getElementById("users_table").innerHTML = li;
        })
}
getAllUsers()

// новый пользователь

const table = document.querySelector('table')
let url = 'http://localhost:8080/api/users';
let form = document.getElementById('add');
form.addEventListener('submit', function (e) {
    e.preventDefault()
    let name = document.getElementById('name').value
    let lastName = document.getElementById('lastName').value
    let email = document.getElementById('email').value
    let password = document.getElementById('password').value
    let address = document.getElementById('address').value
    let age = document.getElementById('age').value

    fetch('http://localhost:8080/api/users', {
        method: 'POST',
        body: JSON.stringify({
            name: name,
            lastName: lastName,
            email: email,
            password: password,
            address: address,
            age: age
        }),
        headers: {
            "Content-Type":"application/json"
        }
    })
        .then(function (response) {
            return response.json()
        })
        .then(function (data) {
            console.log(data)
        })
    setTimeout(test,100);
    function test() {
        document.location.href = 'http://localhost:8080/admin'
    }
})

table.addEventListener('click', (e) => {
    e.preventDefault();
    let delButtonIsPressed = e.target.id === 'delete-user';
    let userId = e.target.parentElement.dataset.id;
    if (delButtonIsPressed) {
        fetch(`${url}/${userId}`, {
            method: 'DELETE'
        }).then(res => res.text())
            .then(() => location.reload())
    }
})


let editForm = document.getElementById('update');
let urlEdit = 'http://localhost:8080/api/users'
editForm.addEventListener('submit', function (e) {
    e.preventDefault();
    let id = document.getElementById('editId').value
    let name = document.getElementById('editName').value
    let lastName = document.getElementById('editLastName').value
    let email = document.getElementById('editEmail').value
    let password = document.getElementById('editPassword').value
    let address = document.getElementById('editAddress').value
    let age = document.getElementById('editAge').value
    fetch(urlEdit, {
        method: 'PUT',
        body: JSON.stringify({
            id: id,
            name: name,
            lastName: lastName,
            email: email,
            password: password,
            address: address,
            age: age
        }),
        headers: {
            "Content-Type":"application/json"
        }
    }).then(function (response) {
        return response.json()
    }).then(function (data) {
        console.log(data)
    })
    setTimeout(test,100);
    function test() {
        document.location.href = 'http://localhost:8080/admin'
    }
})

function getUserdata(idU) {
    document.getElementById('editId').value = idU;
    document.getElementById('editName').value = $('#nameValue' + idU).text();
    document.getElementById('editLastName').value = $('#lastNameValue' + idU).text();
    document.getElementById('editEmail').value = $('#emailValue' + idU).text();
    document.getElementById('editPassword').value = $('#passwordValue' + idU).text();
    document.getElementById('editAddress').value = $('#addressValue' + idU).text();
    document.getElementById('editAge').value = $('#ageValue' + idU).text();
}


function getUser() {
    let response = fetch('http://localhost:8080/api/users/user')
        .then((res) => {
            return  res.json()
        }).then((data) => {
            console.log(data)
            let userRoles = '';
            for (let i = 0; i < data.roles.length; i++) {
                userRoles += `${data.roles[i].role}`
            }
            let li = '';
            li += `  <tr>
            <th scope="col">id</th>
            <th scope="col">name</th>
            <th scope="col">lastName</th>
            <th scope="col">email</th>
            <th scope="col">address</th>
            <th scope="col">age</th>
            <th scope="col">role</th>
            </tr>
            <tr>
                            <td>${data.id}</td>
                            <td>${data.name}</td>
                            <td>${data.lastName}</td>
                            <td>${data.email}</td>
                            <td>${data.address}</td>
                            <td>${data.age}</td>
                            <td>${userRoles}</td>
            </tr>`;

            document.getElementById('userAdmin').innerHTML = li;
        })
}
getUser()
</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>